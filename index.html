<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atheist Protocol (APT) Dashboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@web3modal/html@2.7.1/dist/web3modal-html.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/i18next@21.9.1/dist/umd/i18next.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <!-- Language Toggle -->
        <div class="flex justify-end mb-4">
            <button id="langToggle" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" disabled>
                <span data-i18n="toggleLanguage">Switch to Hindi</span>
            </button>
        </div>

        <h1 class="text-3xl font-bold text-center mb-6" data-i18n="dashboardTitle">Atheist Protocol (APT) Dashboard</h1>
        <div id="i18nError" class="hidden text-red-500 mb-4">Translation library failed to load. Displaying in English.</div>
        <div id="walletInfo" class="mb-4 p-4 bg-white rounded shadow">
            <p data-i18n="wallet">Wallet: <span id="walletAddress">Connect Wallet</span></p>
            <p data-i18n="aptBalance">APT Balance: <span id="tokenBalance">0</span></p>
            <p data-i18n="bnbBalance">BNB Balance: <span id="bnbBalance">0</span></p>
            <p data-i18n="rewardPoolBalance">Reward Pool Balance: <span id="rewardPoolBalance">0</span> APT</p>
            <p data-i18n="stakingStatus">Staking Status: <span id="stakingStatus">Unknown</span></p>
            <button id="connectWallet" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-i18n="connectWallet">Connect Wallet</button>
        </div>

        <!-- Referral Section -->
        <div class="mb-4 p-4 bg-white rounded shadow">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="referralSection">Referral Program</h2>
            <p data-i18n="referralLink">Your Referral Link: <span id="referralLink">Connect wallet to generate</span></p>
            <button id="copyReferralLink" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mt-2" data-i18n="copyLink" disabled>Copy Link</button>
            <p data-i18n="referralRewards">Referral Rewards: <span id="referralRewards">0</span> APT</p>
            <button id="claimReferralButton" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mt-2" data-i18n="claimRewards" disabled>Claim Rewards</button>
        </div>

        <!-- Real-Time Dashboard -->
        <div class="mb-4 p-4 bg-white rounded shadow">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="realTimeDashboard">Real-Time Dashboard</h2>
            <p data-i18n="flexibleAPR">Flexible Staking APR: <span id="flexibleAPR">0%</span></p>
            <p data-i18n="lock60APR">60-Day Lock APR: <span id="lock60APR">0%</span></p>
            <p data-i18n="lock180APR">180-Day Lock APR: <span id="lock180APR">0%</span></p>
            <p data-i18n="lock360APR">360-Day Lock APR: <span id="lock360APR">0%</span></p>
        </div>

        <!-- Staking Section -->
        <div class="mb-4 p-4 bg-white rounded shadow">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="stakingSection">Staking</h2>
            <label class="block mb-2" data-i18n="amountAPT">Amount (APT):</label>
            <input id="stakeAmount" type="number" class="border p-2 w-full mb-2 rounded" placeholder="1000">
            <label class="block mb-2" data-i18n="choosePlan">Choose Plan:</label>
            <select id="stakePlan" class="border p-2 w-full mb-2 rounded">
                <option value="0" data-i18n="flexiblePlan">Flexible (2% APR)</option>
                <option value="1" data-i18n="lock60Plan">60 Days (4% APR)</option>
                <option value="2" data-i18n="lock180Plan">180 Days (6% APR)</option>
                <option value="3" data-i18n="lock360Plan">360 Days (10% APR)</option>
            </select>
            <label class="block mb-2" data-i18n="referrerAddress">Referrer Address (Optional):</label>
            <input id="referrerAddress" type="text" class="border p-2 w-full mb-2 rounded" placeholder="0x...">
            <button id="stakeButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-i18n="stake" disabled>Stake</button>
        </div>

        <!-- Unstaking Section -->
        <div class="mb-4 p-4 bg-white rounded shadow">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="unstakingSection">Unstaking</h2>
            <label class="block mb-2" data-i18n="stakeIndex">Stake Index:</label>
            <input id="unstakeIndex" type="number" class="border p-2 w-full mb-2 rounded" placeholder="0">
            <button id="unstakeButton" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" data-i18n="unstake" disabled>Unstake</button>
            <div id="stakeInfo" class="mt-4"></div>
        </div>

        <!-- Transfer Section -->
        <div class="mb-4 p-4 bg-white rounded shadow">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="transferSection">Token Transfer</h2>
            <label class="block mb-2" data-i18n="receiverAddress">Receiver Address:</label>
            <input id="transferRecipient" type="text" class="border p-2 w-full mb-2 rounded" placeholder="0x...">
            <label class="block mb-2" data-i18n="amountAPT">Amount (APT):</label>
            <input id="transferAmount" type="number" class="border p-2 w-full mb-2 rounded" placeholder="1000">
            <p data-i18n="estimatedFee">Estimated Fee: <span id="transferFee">0</span> BNB</p>
            <button id="calculateFeeButton" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mb-2" data-i18n="checkFee">Check Fee</button>
            <button id="transferButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-i18n="transfer" disabled>Transfer</button>
        </div>

        <!-- Owner Controls -->
        <div id="ownerControls" class="mb-4 p-4 bg-white rounded shadow hidden">
            <h2 class="text-2xl font-semibold mb-4" data-i18n="ownerControls">Owner Controls</h2>
            <label class="block mb-2" data-i18n="newBaseFee">New Base Fee (BNB):</label>
            <input id="newBaseFee" type="number" step="0.00000001" class="border p-2 w-full mb-2 rounded" placeholder="0.00005">
            <label class="block mb-2" data-i18n="newFeePerToken">New Fee Per Token (BNB):</label>
            <input id="newFeePerToken" type="number" step="0.000000000000000001" class="border p-2 w-full mb-2 rounded" placeholder="0.000000001">
            <button id="setFeeButton" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 mb-2" data-i18n="updateFee" disabled>Update Fee</button>
            <label class="block mb-2" data-i18n="planIndex">Plan Index:</label>
            <input id="aprPlanIndex" type="number" class="border p-2 w-full mb-2 rounded" placeholder="0">
            <label class="block mb-2" data-i18n="newAPR">New APR (Basis Points):</label>
            <input id="newAPR" type="number" class="border p-2 w-full mb-2 rounded" placeholder="300">
            <button id="setAPRButton" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 mb-2" data-i18n="updateAPR" disabled>Update APR</button>
            <button id="disableStakingButton" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 mb-2" data-i18n="disableStaking" disabled>Disable Staking</button>
            <label class="block mb-2" data-i18n="withdrawBNB">Withdraw BNB (BNB):</label>
            <input id="withdrawAmount" type="number" step="0.0001" class="border p-2 w-full mb-2 rounded" placeholder="0.01">
            <button id="withdrawBNBButton" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" data-i18n="withdrawBNBBtn" disabled>Withdraw BNB</button>
            <p data-i18n="contractBNBBalance">Contract BNB Balance: <span id="contractBalance">0</span> BNB</p>
        </div>
    </div>

    <script>
        // Initialize i18next for multilingual support
        function initializeI18next() {
            if (typeof i18next === 'undefined') {
                console.error('i18next is not loaded. Falling back to English.');
                document.getElementById('i18nError').classList.remove('hidden');
                document.getElementById('langToggle').disabled = true;
                updateTranslations({}); // Use default English text
                return;
            }

            i18next.init({
                lng: 'en',
                resources: {
                    en: {
                        translation: {
                            toggleLanguage: 'Switch to Hindi',
                            dashboardTitle: 'Atheist Protocol (APT) Dashboard',
                            wallet: 'Wallet:',
                            aptBalance: 'APT Balance:',
                            bnbBalance: 'BNB Balance:',
                            rewardPoolBalance: 'Reward Pool Balance:',
                            stakingStatus: 'Staking Status:',
                            connectWallet: 'Connect Wallet',
                            referralSection: 'Referral Program',
                            referralLink: 'Your Referral Link:',
                            copyLink: 'Copy Link',
                            referralRewards: 'Referral Rewards:',
                            claimRewards: 'Claim Rewards',
                            realTimeDashboard: 'Real-Time Dashboard',
                            flexibleAPR: 'Flexible Staking APR:',
                            lock60APR: '60-Day Lock APR:',
                            lock180APR: '180-Day Lock APR:',
                            lock360APR: '360-Day Lock APR:',
                            stakingSection: 'Staking',
                            amountAPT: 'Amount (APT):',
                            choosePlan: 'Choose Plan:',
                            flexiblePlan: 'Flexible (2% APR)',
                            lock60Plan: '60 Days (4% APR)',
                            lock180Plan: '180 Days (6% APR)',
                            lock360Plan: '360 Days (10% APR)',
                            referrerAddress: 'Referrer Address (Optional):',
                            stake: 'Stake',
                            unstakingSection: 'Unstaking',
                            stakeIndex: 'Stake Index:',
                            unstake: 'Unstake',
                            transferSection: 'Token Transfer',
                            receiverAddress: 'Receiver Address:',
                            estimatedFee: 'Estimated Fee:',
                            checkFee: 'Check Fee',
                            transfer: 'Transfer',
                            ownerControls: 'Owner Controls',
                            newBaseFee: 'New Base Fee (BNB):',
                            newFeePerToken: 'New Fee Per Token (BNB):',
                            updateFee: 'Update Fee',
                            planIndex: 'Plan Index:',
                            newAPR: 'New APR (Basis Points):',
                            updateAPR: 'Update APR',
                            disableStaking: 'Disable Staking',
                            withdrawBNB: 'Withdraw BNB (BNB):',
                            withdrawBNBBtn: 'Withdraw BNB',
                            contractBNBBalance: 'Contract BNB Balance:',
                            active: 'Active',
                            inactive: 'Inactive',
                            noStakes: 'No Stakes',
                            stakeSuccess: 'Staking Successful!',
                            stakeError: 'Staking Error',
                            unstakeSuccess: 'Unstaking Successful!',
                            unstakeError: 'Unstaking Error',
                            feeError: 'Fee Calculation Error',
                            transferSuccess: 'Transfer Successful!',
                            transferError: 'Transfer Error',
                            claimSuccess: 'Referral Rewards Claimed!',
                            claimError: 'Referral Claim Error',
                            feeUpdateSuccess: 'Fee Update Successful!',
                            feeUpdateError: 'Fee Update Error',
                            aprUpdateSuccess: 'APR Update Successful!',
                            aprUpdateError: 'APR Update Error',
                            disableStakingSuccess: 'Staking Disabled!',
                            disableStakingError: 'Disable Staking Error',
                            withdrawSuccess: 'BNB Withdrawal Successful!',
                            withdrawError: 'BNB Withdrawal Error',
                            start: 'Start',
                            lock: 'Lock',
                            days: 'Days',
                            rewards: 'Rewards'
                        }
                    },
                    hi: {
                        translation: {
                            toggleLanguage: 'अंग्रेजी में स्विच करें',
                            dashboardTitle: 'एथीस्ट प्रोटोकॉल (APT) डैशबोर्ड',
                            wallet: 'वॉलेट:',
                            aptBalance: 'APT बैलेंस:',
                            bnbBalance: 'BNB बैलेंस:',
                            rewardPoolBalance: 'रिवॉर्ड पूल बैलेंस:',
                            stakingStatus: 'स्टेकिंग स्थिति:',
                            connectWallet: 'वॉलेट कनेक्ट करें',
                            referralSection: 'रेफरल प्रोग्राम',
                            referralLink: 'आपका रेफरल लिंक:',
                            copyLink: 'लिंक कॉपी करें',
                            referralRewards: 'रेफरल रिवॉर्ड्स:',
                            claimRewards: 'रिवॉर्ड्स क्लेम करें',
                            realTimeDashboard: 'रियल-टाइम डैशबोर्ड',
                            flexibleAPR: 'फ्लेक्सिबल स्टेकिंग APR:',
                            lock60APR: '60-दिन लॉक APR:',
                            lock180APR: '180-दिन लॉक APR:',
                            lock360APR: '360-दिन लॉक APR:',
                            stakingSection: 'स्टेकिंग',
                            amountAPT: 'अमाउंट (APT):',
                            choosePlan: 'प्लान चुनें:',
                            flexiblePlan: 'फ्लेक्सिबल (2% APR)',
                            lock60Plan: '60 दिन (4% APR)',
                            lock180Plan: '180 दिन (6% APR)',
                            lock360Plan: '360 दिन (10% APR)',
                            referrerAddress: 'रेफरर एड्रेस (वैकल्पिक):',
                            stake: 'स्टेक करें',
                            unstakingSection: 'अनस्टेकिंग',
                            stakeIndex: 'स्टेक इंडेक्स:',
                            unstake: 'अनस्टेक करें',
                            transferSection: 'टोकन ट्रांसफर',
                            receiverAddress: 'रिसीवर एड्रेस:',
                            estimatedFee: 'अनुमानित फीस:',
                            checkFee: 'फीस चेक करें',
                            transfer: 'ट्रांसफर करें',
                            ownerControls: 'मालिक कंट्रोल्स',
                            newBaseFee: 'नया बेस फीस (BNB):',
                            newFeePerToken: 'नया प्रति टोकन फीस (BNB):',
                            updateFee: 'फीस अपडेट करें',
                            planIndex: 'प्लान इंडेक्स:',
                            newAPR: 'नया APR (बेसिस पॉइंट्स):',
                            updateAPR: 'APR अपडेट करें',
                            disableStaking: 'स्टेकिंग बंद करें',
                            withdrawBNB: 'BNB निकालें (BNB):',
                            withdrawBNBBtn: 'BNB निकालें',
                            contractBNBBalance: 'कॉन्ट्रैक्ट BNB बैलेंस:',
                            active: 'सक्रिय',
                            inactive: 'बंद',
                            noStakes: 'कोई स्टेक नहीं',
                            stakeSuccess: 'Stake Successful!',
                            stakeError: 'Stake exited!',
                            unstakeSuccess: 'Unstake successful!',
                            unstakeError: 'Unstake failed',
                            feeError: 'Fee calculation error',
                            transferSuccess: 'Transfer successful!',
                            transferError: 'Transfer exited!',
                            claimSuccess: 'Referral rewards claimed!',
                            claimError: 'Referral claim exited!',
                            feeUpdateSuccess: 'Fee update successful!',
                            feeUpdateError: 'Fee update exited!',
                            aprUpdateSuccess: 'APR update successful!',
                            aprUpdateError: 'APR update exited!',
                            disableStakingSuccess: 'Staking disabled!',
                            disableStakingError: 'Disable staking exited!',
                            withdrawSuccess: 'BNB withdrawal successful!',
                            withdrawError: 'BNB withdrawal exited!',
                            start: 'शुरू',
                            lock: 'लॉक',
                            days: 'दिन',
                            rewards: 'रिवॉर्ड्स'
                        }
                    }
                }
            }, (err) => {
                if (err) {
                    console.error('i18next initialization failed:', err);
                    document.getElementById('i18nError').classList.remove('hidden');
                    document.getElementById('langToggle').disabled = true;
                    updateTranslations({});
                } else {
                    document.getElementById('langToggle').disabled = false;
                    updateTranslations(i18next);
                }
            });
        }

        // Update translations
        function updateTranslations(i18n) {
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.getAttribute('data-i18n');
                elem.innerHTML = i18n && i18n.t ? i18n.t(key) : key;
            });
        }

        // Language toggle
        document.getElementById('langToggle').addEventListener('click', () => {
            if (typeof i18next === 'undefined') {
                console.error('i18next not loaded for language toggle');
                return;
            }
            const newLang = i18next.language === 'en' ? 'hi' : 'en';
            i18next.changeLanguage(newLang, (err) => {
                if (err) {
                    console.error('Language change failed:', err);
                    return;
                }
                updateTranslations(i18next);
                document.getElementById('langToggle').innerHTML = `<span data-i18n="toggleLanguage">${i18next.t('toggleLanguage')}</span>`;
            });
        });

        // Initialize i18next after window load to ensure script is loaded
        window.addEventListener('load', initializeI18next);

        // Web3Modal configuration
        const projectId = 'YOUR_WALLET_CONNECT_PROJECT_ID'; // Get from https://cloud.walletconnect.com
        if (!projectId || projectId === 'YOUR_WALLET_CONNECT_PROJECT_ID') {
            console.error('WalletConnect projectId is missing. Get it from https://cloud.walletconnect.com');
            alert('WalletConnect configuration error. Please contact the developer.');
        }

        const chains = [
            {
                chainId: '0x61', // BNB Testnet
                name: 'BNB Smart Chain Testnet',
                currency: 'BNB',
                explorerUrl: 'https://testnet.bscscan.com',
                rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545'
            }
        ];

        const web3Modal = window.Web3Modal && new window.Web3Modal.Web3Modal({
            projectId,
            chains,
            walletConnectVersion: 2
        });

        // Contract ABI (Paste from Remix after compiling AtheistProtocol.sol)
        const contractABI = [ /* Paste ABI here */ ];

        // Contract Address (Update after deployment on BNB Testnet)
        const contractAddress = '0xYOUR_CONTRACT_ADDRESS_HERE';
        let contract;
        let accounts;
        let web3;
        let ownerAddress;

        // Connect Wallet
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!web3Modal) {
                alert((i18next.t ? i18next.t('connectWallet') : 'Connect Wallet') + ': Web3Modal not loaded');
                console.error('Web3Modal is not available');
                return;
            }
            try {
                const provider = await web3Modal.connect();
                web3 = new Web3(provider);
                accounts = await web3.eth.getAccounts();
                if (!contractABI.length || contractAddress === '0xYOUR_CONTRACT_ADDRESS_HERE') {
                    alert('Contract ABI or address not configured. Please update index.html.');
                    return;
                }
                contract = new web3.eth.Contract(contractABI, contractAddress);
                ownerAddress = await contract.methods.owner().call();
                document.getElementById('walletAddress').innerText = accounts[0];
                toggleOwnerControls();
                generateReferralLink();
                updateBalances();
                updateStakeInfo();
                updateReferralRewards();
                updateContractBalance();
                updateStakingStatus();
                updateDashboard();
                enableButtons();
            } catch (error) {
                console.error('Wallet connection error:', error);
                alert((i18next.t ? i18next.t('connectWallet') : 'Connect Wallet') + ': ' + error.message);
            }
        });

        // Toggle Owner Controls visibility
        function toggleOwnerControls() {
            const ownerControls = document.getElementById('ownerControls');
            if (accounts && accounts[0].toLowerCase() === ownerAddress.toLowerCase()) {
                ownerControls.classList.remove('hidden');
            } else {
                ownerControls.classList.add('hidden');
            }
        }

        // Enable buttons after wallet connection
        function enableButtons() {
            document.getElementById('stakeButton').disabled = false;
            document.getElementById('unstakeButton').disabled = false;
            document.getElementById('transferButton').disabled = false;
            document.getElementById('claimReferralButton').disabled = false;
            document.getElementById('setFeeButton').disabled = false;
            document.getElementById('setAPRButton').disabled = false;
            document.getElementById('disableStakingButton').disabled = false;
            document.getElementById('withdrawBNBButton').disabled = false;
        }

        // Generate Referral Link
        function generateReferralLink() {
            if (!accounts || !accounts[0]) return;
            const baseUrl = window.location.origin + window.location.pathname;
            const referralLink = `${baseUrl}?ref=${accounts[0]}`;
            document.getElementById('referralLink').innerText = referralLink;
            document.getElementById('copyReferralLink').disabled = false;

            // Check URL for referrer
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = urlParams.get('ref');
            if (referrer && web3.utils.isAddress(referrer)) {
                document.getElementById('referrerAddress').value = referrer;
            }
        }

        // Copy Referral Link
        document.getElementById('copyReferralLink').addEventListener('click', () => {
            const referralLink = document.getElementById('referralLink').innerText;
            navigator.clipboard.writeText(referralLink).then(() => {
                alert((i18next.t ? i18next.t('copyLink') : 'Copy Link') + ' Copied!');
            }).catch(err => {
                console.error('Copy link error:', err);
                alert((i18next.t ? i18next.t('copyLink') : 'Copy Link') + ': ' + err.message);
            });
        });

        // Update Balances
        async function updateBalances() {
            if (!contract || !accounts) return;
            try {
                const balance = await contract.methods.balanceOf(accounts[0]).call();
                document.getElementById('tokenBalance').innerText = web3.utils.fromWei(balance, 'ether');
                const bnbBalance = await web3.eth.getBalance(accounts[0]);
                document.getElementById('bnbBalance').innerText = web3.utils.fromWei(bnbBalance, 'ether');
                const poolBalance = await contract.methods.getRewardPoolBalance().call();
                document.getElementById('rewardPoolBalance').innerText = web3.utils.fromWei(poolBalance, 'ether');
            } catch (error) {
                console.error('Update balances error:', error);
            }
        }

        // Update Staking Status
        async function updateStakingStatus() {
            if (!contract) return;
            try {
                const isActive = await contract.methods.isStakingActive().call();
                document.getElementById('stakingStatus').innerText = i18next.t ? i18next.t(isActive ? 'active' : 'inactive') : (isActive ? 'Active' : 'Inactive');
                document.getElementById('stakeButton').disabled = !isActive;
            } catch (error) {
                console.error('Update staking status error:', error);
            }
        }

        // Update Real-Time Dashboard
        async function updateDashboard() {
            if (!contract) return;
            try {
                const plans = [
                    await contract.methods.stakingPlans(0).call(),
                    await contract.methods.stakingPlans(1).call(),
                    await contract.methods.stakingPlans(2).call(),
                    await contract.methods.stakingPlans(3).call()
                ];
                document.getElementById('flexibleAPR').innerText = `${plans[0].apr / 100}%`;
                document.getElementById('lock60APR').innerText = `${plans[1].apr / 100}%`;
                document.getElementById('lock180APR').innerText = `${plans[2].apr / 100}%`;
                document.getElementById('lock360APR').innerText = `${plans[3].apr / 100}%`;
            } catch (error) {
                console.error('Update dashboard error:', error);
            }
        }

        // Update Stake Info
        async function updateStakeInfo() {
            if (!contract || !accounts) return;
            let stakeInfo = '';
            try {
                for (let i = 0; i < 10; i++) {
                    try {
                        const stake = await contract.methods.getStakeInfo(accounts[0], i).call();
                        if (stake.amount > 0) {
                            stakeInfo += `<p>${i18next.t ? i18next.t('stake') : 'Stake'} ${i}: ${web3.utils.fromWei(stake.amount, 'ether')} APT, ${i18next.t ? i18next.t('start') : 'Start'}: ${new Date(stake.startTime * 1000).toLocaleString()}, ${i18next.t ? i18next.t('lock') : 'Lock'}: ${stake.lockPeriod / 86400} ${i18next.t ? i18next.t('days') : 'Days'}, ${i18next.t ? i18next.t('rewards') : 'Rewards'}: ${web3.utils.fromWei(stake.rewards, 'ether')} APT</p>`;
                        }
                    } catch (error) {
                        break;
                    }
                }
                document.getElementById('stakeInfo').innerHTML = stakeInfo || (i18next.t ? i18next.t('noStakes') : 'No Stakes');
            } catch (error) {
                console.error('Update stake info error:', error);
            }
        }

        // Update Referral Rewards
        async function updateReferralRewards() {
            if (!contract || !accounts) return;
            try {
                const rewards = await contract.methods.getReferralRewards(accounts[0]).call();
                document.getElementById('referralRewards').innerText = web3.utils.fromWei(rewards, 'ether');
            } catch (error) {
                console.error('Update referral rewards error:', error);
            }
        }

        // Update Contract BNB Balance
        async function updateContractBalance() {
            if (!contract) return;
            try {
                const balance = await contract.methods.getContractBalance().call();
                document.getElementById('contractBalance').innerText = web3.utils.fromWei(balance, 'ether');
            } catch (error) {
                console.error('Update contract balance error:', error);
            }
        }

        // Stake
        document.getElementById('stakeButton').addEventListener('click', async () => {
            if (!contract || !accounts) {
                alert((i18next.t ? i18next.t('stakeError') : 'Staking Error') + ': Wallet not connected');
                return;
            }
            const amount = document.getElementById('stakeAmount').value;
            const planIndex = document.getElementById('stakePlan').value;
            const referrer = document.getElementById('referrerAddress').value || '0x0000000000000000000000000000000000000000';
            if (!web3.utils.isAddress(referrer)) {
                alert((i18next.t ? i18next.t('stakeError') : 'Staking Error') + ': Invalid referrer address');
                return;
            }
            try {
                await contract.methods.approve(contractAddress, web3.utils.toWei(amount, 'ether')).send({ from: accounts[0] });
                await contract.methods.depositStake(web3.utils.toWei(amount, 'ether'), planIndex, referrer).send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('stakeSuccess') : 'Staking Successful!');
                updateBalances();
                updateStakeInfo();
                updateDashboard();
            } catch (error) {
                console.error('Stake error:', error);
                alert((i18next.t ? i18next.t('stakeError') : 'Staking Error') + ': ' + error.message);
            }
        });

        // Unstake
        document.getElementById('unstakeButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            const stakeIndex = document.getElementById('unstakeIndex').value;
            try {
                await contract.methods.unstake(stakeIndex).send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('unstakeSuccess') : 'Unstaking Successful!');
                updateBalances();
                updateStakeInfo();
            } catch (error) {
                console.error('Unstake error:', error);
                alert((i18next.t ? i18next.t('unstakeError') : 'Unstaking Error') + ': ' + error.message);
            }
        });

        // Calculate Transfer Fee
        document.getElementById('calculateFeeButton').addEventListener('click', async () => {
            if (!contract) return;
            const amount = document.getElementById('transferAmount').value;
            try {
                const fee = await contract.methods.calculateTransferFee(web3.utils.toWei(amount, 'ether')).call();
                document.getElementById('transferFee').innerText = web3.utils.fromWei(fee, 'ether');
            } catch (error) {
                console.error('Calculate fee error:', error);
                alert((i18next.t ? i18next.t('feeError') : 'Fee Calculation Error') + ': ' + error.message);
            }
        });

        // Transfer Tokens
        document.getElementById('transferButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            const recipient = document.getElementById('transferRecipient').value;
            const amount = document.getElementById('transferAmount').value;
            if (!web3.utils.isAddress(recipient)) {
                alert((i18next.t ? i18next.t('transferError') : 'Transfer Error') + ': Invalid recipient address');
                return;
            }
            try {
                const fee = await contract.methods.calculateTransferFee(web3.utils.toWei(amount, 'ether')).call();
                await contract.methods.transfer(recipient, web3.utils.toWei(amount, 'ether')).send({
                    from: accounts[0],
                    value: fee
                });
                alert(i18next.t ? i18next.t('transferSuccess') : 'Transfer Successful!');
                updateBalances();
            } catch (error) {
                console.error('Transfer error:', error);
                alert((i18next.t ? i18next.t('transferError') : 'Transfer Error') + ': ' + error.message);
            }
        });

        // Claim Referral Rewards
        document.getElementById('claimReferralButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            try {
                await contract.methods.claimReferralRewards().send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('claimSuccess') : 'Referral Rewards Claimed!');
                updateBalances();
                updateReferralRewards();
            } catch (error) {
                console.error('Claim rewards error:', error);
                alert((i18next.t ? i18next.t('claimError') : 'Referral Claim Error') + ': ' + error.message);
            }
        });

        // Update Transfer Fee
        document.getElementById('setFeeButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            const baseFee = document.getElementById('newBaseFee').value;
            const feePerToken = document.getElementById('newFeePerToken').value;
            try {
                await contract.methods.setTransferFee(
                    web3.utils.toWei(baseFee, 'ether'),
                    web3.utils.toWei(feePerToken, 'ether')
                ).send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('feeUpdateSuccess') : 'Fee Update Successful!');
            } catch (error) {
                console.error('Set fee error:', error);
                alert((i18next.t ? i18next.t('feeUpdateError') : 'Fee Update Error') + ': ' + error.message);
            }
        });

        // Update APR
        document.getElementById('setAPRButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            const planIndex = document.getElementById('aprPlanIndex').value;
            const newAPR = document.getElementById('newAPR').value;
            try {
                await contract.methods.setStakingPlanAPR(planIndex, newAPR).send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('aprUpdateSuccess') : 'APR Update Successful!');
                updateDashboard();
            } catch (error) {
                console.error('Set APR error:', error);
                alert((i18next.t ? i18next.t('aprUpdateError') : 'APR Update Error') + ': ' + error.message);
            }
        });

        // Disable Staking
        document.getElementById('disableStakingButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            try {
                await contract.methods.disableStaking().send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('disableStakingSuccess') : 'Staking Disabled!');
                updateStakingStatus();
            } catch (error) {
                console.error('Disable staking error:', error);
                alert((i18next.t ? i18next.t('disableStakingError') : 'Disable Staking Error') + ': ' + error.message);
            }
        });

        // Withdraw BNB
        document.getElementById('withdrawBNBButton').addEventListener('click', async () => {
            if (!contract || !accounts) return;
            const amount = document.getElementById('withdrawAmount').value;
            try {
                await contract.methods.withdrawBNB(web3.utils.toWei(amount, 'ether')).send({ from: accounts[0] });
                alert(i18next.t ? i18next.t('withdrawSuccess') : 'BNB Withdrawal Successful!');
                updateContractBalance();
            } catch (error) {
                console.error('Withdraw BNB error:', error);
                alert((i18next.t ? i18next.t('withdrawError') : 'BNB Withdrawal Error') + ': ' + error.message);
            }
        });
    </script>
</body>
</html>
